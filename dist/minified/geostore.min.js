!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"object"==typeof a.navigator&&("undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.GeoStore=b().GeoStore)}(this,function(){function a(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a}function b(){this._events={},this._once={},this._maxListeners=10}function c(){var a=this;this._destination=[],this._emit=this.emit,this.emit=function(b,c){var d;if("data"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);else if("end"===b)for(d=a._destination.length;d--;)a._destination[d].write(c);a._emit(b,c)}}function d(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return b.apply(a,c||arguments)}}function e(a){if(!a.store||!a.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.deferred=a.deferred?a.deferred:f.Deferred,this.index=a.index,this.store=a.store,this._stream=null}b.prototype._add=function(a,b,c){var d={listener:b};return c&&(d.once=!0),this._events[a]?this._events[a].push(d):this._events[a]=d,this._maxListeners&&this._events[a].count>this._maxListeners&&console&&console.warn&&console.warn("EventEmitter Error: Maximum number of listeners"),this},b.prototype.on=b.prototype.addListener=function(a,b){return this._add(a,b)},b.prototype.once=function(a,b){return this._add(a,b,!0)},b.prototype.removeListener=function(a){if(!this._events[a])return this;for(var b=this._events.length-1;b--;)this._events[b].listener===callback&&this._events.splice(b,1);return this},b.prototype.removeAllListeners=function(a){return this._events[a]=void 0,this},b.prototype.setMaxListeners=function(a){return this._maxListeners=a,this},b.prototype.emit=function(){var a,b=Array.prototype.slice.apply(arguments),c=[];if(b.length){var d=b.shift();if(this._events[d])for(a=this._events[d].length;a--;)this._events[d].listener.apply(b),this._events[d].once&&c.push(listener);for(a=c.length;a--;)this.removeListener(d,c[a])}return this},a(c,b),c.prototype.pipe=function(a){this._destination.push(a)},c.prototype.unpipe=function(a){if(a)for(var b=this._destination.length-1;b--;)this._destination[b].listener===a&&this._destination.splice(b,1);else this._destination=[]};var f,g={};return"object"==typeof this.navigator&&(f=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(f=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(f=arguments[0]),e.prototype.add=function(a,b){var c,d=new this.deferred;if(b&&d.then(function(a){b(null,a)},function(a){b(a,null)}),!a.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if("Feature"===a.type&&!a.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if("FeatureCollection"===a.type){for(var e=0;e<a.features.length;e++){var g=a.features[e];if(c=f.Tools.calculateBounds(g),!g.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},g.id)}this.store.add(a,d)}else c=f.Tools.calculateBounds(a),this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},a.id),this.store.add(a,d);return d},e.prototype.remove=function(a,b){var c=new this.deferred;return b&&c.then(function(a){b(null,a)},function(a){b(a,null)}),this.get(a).then(d(this,function(b){this.index.remove(b,a,d(this,function(b){b?c.reject("Could not remove from index"):this.store.remove(a,c)}))}),function(){c.reject("Could not remove feature")}),c},e.prototype.contains=function(a,b){var c=new f.Primitive(a),e=new this.deferred;b&&e.then(function(a){b(null,a)},function(a){b(a,null)});var g=f.Tools.calculateEnvelope(c);return this.index.search(g).then(d(this,function(a){var b=[],d=0,g=0,h=function(h){d++;var i=new f.Primitive(h.geometry);c.within(i)&&(this._stream?d===a.length-1?this._stream.emit("end",h):this._stream.emit("data",h):b.push(h)),d>=a.length&&(g?e.reject("Could not get all geometries"):this._stream?(this._stream=null,e.resolve()):e.resolve(b)),d>=a.length&&g&&e.reject("Could not get all geometries")},i=function(){d++,g++,d>=a.length&&e.reject("Could not get all geometries")};if(a.length)for(var j=0;j<a.length;j++)this.get(a[j]).then(h,i);else e.resolve(b)})),e},e.prototype.within=function(a,b){var c=new f.Primitive(a),e=new this.deferred;b&&e.then(function(a){b(null,a)},function(a){b(a,null)});var g=f.Tools.calculateEnvelope(c);return this.index.within(g).then(d(this,function(a){var b=[],d=0,g=0,h=function(h){d++;var i=new f.Primitive(h.geometry);i.within(c)&&(this._stream?d===a.length-1?this._stream.emit("end",h):this._stream.emit("data",h):b.push(h)),d>=a.length&&(g?e.reject("Could not get all geometries"):this._stream?(this._stream=null,e.resolve()):e.resolve(b))},i=function(){d++,g++,d>=a.length&&e.reject("Could not get all geometries")};if(a.length)for(var j=0;j<a.length;j++)this.get(a[j]).then(h,i);else e.resolve(b)})),e},e.prototype.update=function(a,b){var c=f.Primitive(a),e=new this.deferred;if(b&&e.then(function(a){b(null,a)},function(a){b(a,null)}),"Feature"!==c.type)throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!c.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");return this.get(c.id).then(d(this,function(a){var b=new f.Primitive(a);this.index.remove(b.envelope(),b.id),this.index.insert(c.envelope(),c.id),this.store.update(c,e)}),function(){e.reject("Could find feature")}),e},e.prototype.get=function(a,b){var c=new this.deferred;return b&&c.then(function(a){b(null,a)},function(a){b(a,null)}),this.store.get(a,c),c},e.prototype.createReadStream=function(){this._stream=new c},g.GeoStore=e,g});
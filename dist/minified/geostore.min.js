!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"object"==typeof a.navigator&&("undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.GeoStore=b().GeoStore)}(this,function(){function a(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return b.apply(a,c||arguments)}}function b(a){if(!a.store||!a.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.deferred=a.deferred?a.deferred:c.Deferred,this.index=a.index,this.store=a.store}var c,d={};return"object"==typeof this.navigator&&(c=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(c=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(c=arguments[0]),b.prototype.add=function(a,b){if(!a.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if("Feature"===a.type&&!a.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if("FeatureCollection"===a.type){for(var d=0;d<a.features.length;d++){var e=a.features[d];if(bbox=c.Tools.calculateBounds(e),!e.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.insert({x:bbox[0],y:bbox[1],w:Math.abs(bbox[0]-bbox[2]),h:Math.abs(bbox[1]-bbox[3])},e.id)}this.store.add(a,b)}else bbox=c.Tools.calculateBounds(a),this.index.insert({x:bbox[0],y:bbox[1],w:Math.abs(bbox[0]-bbox[2]),h:Math.abs(bbox[1]-bbox[3])},a.id),this.store.add(a,b)},b.prototype.remove=function(b,c){this.get(b,a(this,function(d,e){d?c("Could not get feature to remove",null):this.index.remove(e,b,a(this,function(a){a?c("Could not remove from index",null):this.store.remove(b,c)}))}))},b.prototype.contains=function(b,d){var e=new c.Primitive(b),f=new this.deferred;d&&f.then(function(a){d(null,a)},function(a){d(a,null)});var g=c.Tools.calculateEnvelope(e);return this.index.search(g).then(a(this,function(a){var b=[],d=0,g=0,h=function(h){if(d++,h){var i=new c.Primitive(h.geometry);e.within(i)&&b.push(h),d>=a.length&&(g?f.reject("Could not get all geometries"):f.resolve(b)),d>=a.length&&g&&f.reject("Could not get all geometries")}},i=function(){d++,g++,d>=a.length&&f.reject("Could not get all geometries")};if(a.length)for(var j=function(a,b){a?i():h(b)},k=0;k<a.length;k++)this.get(a[k],j);else f.resolve(b)})),f},b.prototype.within=function(b,d){var e=new c.Primitive(b),f=new this.deferred;d&&f.then(function(a){d(null,a)},function(a){d(a,null)});var g=c.Tools.calculateEnvelope(e);return this.index.within(g).then(a(this,function(a){var b=[],d=0,g=0,h=function(h){if(d++,h){var i=new c.Primitive(h.geometry);i.within(e)&&b.push(h),d>=a.length&&(g?f.reject("Could not get all geometries"):f.resolve(b)),d>=a.length&&g&&f.reject("Could not get all geometries")}},i=function(){d++,g++,d>=a.length&&f.reject("Could not get all geometries")};if(a.length)for(var j=function(a,b){a?i():h(b)},k=0;k<a.length;k++)this.get(a[k],j);else f.resolve(b)})),f},b.prototype.update=function(b,d){var e=c.Primitive(b),f=new this.deferred;if(d&&f.then(function(a){d(null,a)},function(a){d(a,null)}),"Feature"!==e.type)throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!e.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");return this.get(e.id,a(this,function(a,b){if(a)d("Could find feature",null);else{var f=new c.Primitive(b);this.index.remove(f.envelope(),f.id),this.index.insert(e.envelope(),e.id),this.store.update(e,d)}})),f},b.prototype.get=function(a,b){this.store.get(a,b)},d.GeoStore=b,d});
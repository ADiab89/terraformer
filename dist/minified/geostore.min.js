!function(a,b){"object"==typeof module&&"object"==typeof module.exports&&(exports=module.exports=b()),"function"==typeof define&&define.amd&&define(["terraformer/terraformer"],b),"object"==typeof a.navigator&&("undefined"==typeof a.Terraformer&&(a.Terraformer={}),a.Terraformer.GeoStore=b().GeoStore)}(this,function(){function a(){this._events={},this._once={},this._maxListeners=10,this._add=function(a,b,c){var d={listener:b};return c&&(d.once=!0),this._events[a]?this._events[a].push(d):this._events[a]=[d],this._maxListeners&&this._events[a].count>this._maxListeners&&console&&console.warn&&console.warn("EventEmitter Error: Maximum number of listeners"),this},this.on=function(a,b){return this._add(a,b)},this.addListener=this.on,this.once=function(a,b){return this._add(a,b,!0)},this.removeListener=function(a){if(!this._events[a])return this;for(var b=this._events.length-1;b--;)this._events[b].listener===callback&&this._events.splice(b,1);return this},this.removeAllListeners=function(a){return this._events[a]=void 0,this},this.setMaxListeners=function(a){return this._maxListeners=a,this},this.emit=function(){var a,b=Array.prototype.slice.apply(arguments),c=[];if(b.length){var d=b.shift();if(this._events[d])for(a=this._events[d].length;a--;)this._events[d][a].listener.apply(null,b),this._events[d][a].once&&c.push(listener);for(a=c.length;a--;)this.removeListener(d,c[a])}return this}}function b(){var b=this;a.call(this),this._destination=[],this._emit=this.emit,this.emit=function(a,c){var d;if("data"===a)for(d=b._destination.length;d--;)b._destination[d].write(c);else if("end"===a)for(d=b._destination.length;d--;)b._destination[d].write(c);b._emit(a,c)}}function c(a,b){var c=arguments.length>2?Array.prototype.slice.call(arguments,2):null;return function(){return b.apply(a,c||arguments)}}function d(a){if(!a.store||!a.index)throw new Error("Terraformer.GeoStore requires an instace of a Terraformer.Store and a instance of Terraformer.RTree");this.deferred=a.deferred?a.deferred:e.Deferred,this.index=a.index,this.store=a.store,this._stream=null}b.prototype.pipe=function(a){this._destination.push(a)},b.prototype.unpipe=function(a){if(a)for(var b=this._destination.length-1;b--;)this._destination[b].listener===a&&this._destination.splice(b,1);else this._destination=[]};var e,f={};return"object"==typeof this.navigator&&(e=this.Terraformer),"object"==typeof module&&"object"==typeof module.exports&&(e=require("terraformer")),arguments[0]&&"function"==typeof define&&define.amd&&(e=arguments[0]),d.prototype.add=function(a,b){var c,d=new this.deferred;if(b&&d.then(function(a){b(null,a)},function(a){b(a,null)}),!a.type.match(/Feature/))throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if("Feature"===a.type&&!a.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");if("FeatureCollection"===a.type){for(var f=0;f<a.features.length;f++){var g=a.features[f];if(c=e.Tools.calculateBounds(g),!g.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},g.id)}this.store.add(a,d)}else c=e.Tools.calculateBounds(a),this.index.insert({x:c[0],y:c[1],w:Math.abs(c[0]-c[2]),h:Math.abs(c[1]-c[3])},a.id),this.store.add(a,d);return d},d.prototype.remove=function(a,b){var d=new this.deferred;return b&&d.then(function(a){b(null,a)},function(a){b(a,null)}),this.get(a).then(c(this,function(b){this.index.remove(b,a,c(this,function(b){b?d.reject("Could not remove from index"):this.store.remove(a,d)}))}),function(){d.reject("Could not remove feature")}),d},d.prototype.contains=function(a,b){var d=new e.Primitive(a),f=new this.deferred;b&&f.then(function(a){b(null,a)},function(a){b(a,null)});var g=e.Tools.calculateEnvelope(d);return this.index.search(g).then(c(this,function(a){var b=[],c=0,g=0,h=this,i=function(i){c++;var j=new e.Primitive(i.geometry);d.within(j)&&(h._stream?c===a.length?h._stream.emit("end",i):h._stream.emit("data",i):b.push(i)),c>=a.length&&(g?f.reject("Could not get all geometries"):h._stream?(h._stream=null,f.resolve()):f.resolve(b)),c>=a.length&&g&&f.reject("Could not get all geometries")},j=function(){c++,g++,c>=a.length&&f.reject("Could not get all geometries")};if(a.length)for(var k=0;k<a.length;k++)this.get(a[k]).then(i,j);else f.resolve(b)})),f},d.prototype.within=function(a,b){var d=new e.Primitive(a),f=new this.deferred;b&&f.then(function(a){b(null,a)},function(a){b(a,null)});var g=e.Tools.calculateEnvelope(d);return this.index.within(g).then(c(this,function(a){var b=[],c=0,g=0,h=this,i=function(i){c++;var j=new e.Primitive(i.geometry);j.within(d)&&(h._stream?c===a.length?h._stream.emit("end",i):h._stream.emit("data",i):b.push(i)),c>=a.length&&(g?f.reject("Could not get all geometries"):h._stream?(h._stream=null,f.resolve()):f.resolve(b))},j=function(){c++,g++,c>=a.length&&f.reject("Could not get all geometries")};if(a.length)for(var k=0;k<a.length;k++)this.get(a[k]).then(i,j);else f.resolve(b)})),f},d.prototype.update=function(a,b){var d=e.Primitive(a),f=new this.deferred;if(b&&f.then(function(a){b(null,a)},function(a){b(a,null)}),"Feature"!==d.type)throw new Error("Terraform.GeoStore : only Features and FeatureCollections are supported");if(!d.id)throw new Error("Terraform.GeoStore : Feature does not have an id property");return this.get(d.id).then(c(this,function(a){var b=new e.Primitive(a);this.index.remove(b.envelope(),b.id),this.index.insert(d.envelope(),d.id),this.store.update(d,f)}),function(){f.reject("Could find feature")}),f},d.prototype.get=function(a,b){var c=new this.deferred;return b&&c.then(function(a){b(null,a)},function(a){b(a,null)}),this.store.get(a,c),c},d.prototype.createReadStream=function(){return this._stream=new b,this._stream},f.GeoStore=d,f});